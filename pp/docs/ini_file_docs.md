Return to the [Main README](../readme.md)
# Peak Patch-Websky INI Parameter File Documentation

As of August 2024, PeakPatch can be setup with `.ini` file, as well as `param.params` file.
You can find these sample files in `example/params` directory.
`.ini` file is preferred, since it is directly read by python and fortran, while the `.params`
file requires python code to generate the binary first, which is then read by fortran.
You pass the parameters file as a third argument to `bin/hpkvd`, and the code can automatically 
discern between the binary `.bin` format (usually `hpkvd_params.bin` generated by `param.params`), 
and `.ini` format, and does reading routines accordingly.

There is also a script in `scripts`, that would allow you to convert any `.ini` ICs to `param.params`,
but not the reverse, since it's a bit more complicated.
You run this script with:
```
./scripts/ini_to_params_converter.sh <your_ini_file_location> <your_desired_params_file_location>
```

`param.params` file is currently the only way to interact with `peakpatchtools.py`.
Also, running with `ini` file has been fully tested only with `hpkvd` part of the code, i.e. `merge_pkvd` or `pks2map` haven't been tested and probably won't work out-of-the-box.

Below is documentation for `.ini` parameters file.

-----

This configuration file is essential for setting up simulations in the Peak Patch-Websky pipeline, influencing both the generation of halo catalogues and the production of sky maps. It is read by the `peak-patch.py` runner script, as well as directly by the fortran code via `modules/ini_reader/config_reader.f90` module. Below, each section corresponds to specific simulation settings and includes detailed descriptions, computational notes, and additional context.

## [boolean_switches]
```markdown
hpkvd_params       = 1 # Generates a Fortran-readable parameter file for hpkvd.f90.
compile_hpkvd      = 1 # Compiles the hpkvd.f90.
create_filterbank  = 1 # Generates a table of smoothing scales for peak finding.
merge_params       = 1 # Creates a Fortran-readable parameter file for merge_pkvd.
compile_merge      = 1 # Compiles the merge_pkvd.f90.
map_params         = 1 # Prepares a Fortran-readable parameter file for map-making.
compile_maps       = 1 # Compiles the pks2map.f90.
batch              = 1 # Generates a job script for the simulation run.
submit             = 0 # Controls the automatic submission of the job script to the scheduler (0 does not submit).
```
This section includes boolean switches that control various preparatory steps and compilation processes in the simulation pipeline.

## [machine_params]
```markdown
machine            = niagara # Specifies the target computing cluster, here 'niagara'.
submit_command     = sbatch  # Defines the command used to submit jobs to the cluster's job scheduler.
```
The cluster information is crucial for ensuring that the simulation runs on the correct hardware and that job submissions are properly formatted.

## [peak_patch_main]
```markdown
seed               = 13579   # Random seed for generating Gaussian initial fields.
run_name           = '512Mpc_n256_nb14_nt2' # Identifier for the simulation run, used in output file naming.
short_name         = '512Mpc_nb14' # A shorter alias for the run.
runtype            = 'single' # Type of run; 'single' for one realization, 'multi' for multiple realizations.
```
Main parameters define the foundational aspects of the simulation such as the initial conditions and the naming convention.

## [random]
```markdown
seed               = 13579   # Random seed for generating Gaussian initial fields.
chi_seed           = 90101 # Seed for generating Gaussian chi field.
```
In this section, you can customize the parameters of randomness in your peakpatch simulation.

## [box_params]
```markdown
boxsize            = 4000.   # Sidelength (Mpc/h) of the simulation volume without buffer zones.
nmesh              = 240     # Sidelength of one "tile" in lattice cells.
nbuff              = 20      # Buffer size in lattice cells, used to avoid edge effects.
ntile              = 1       # Number of tiles the simulation volume is divided into for parallel processing.
largerun           = 0       # Set to 1 for splitting large halo catalogues into multiple files to handle size limitations.
```
This section configures the physical dimensions of the simulation volume and its subdivision for parallel processing.

## [parallelization_params]
```markdown
tlimit             = '1:00:00'    # Wall-clock time limit for the simulation run.
nnodes             = 1            # Number of compute nodes requested.
tpnode             = 1            # Number of parallel tasks per compute node.
ntasks             = -1           # Total number of parallel tasks, calculated as nnodes*tpnode. Set to -1 for automatic calculation.
ncpus              = 1            # Number of CPUs allocated per task.
nompth             = 1            # Number of threads per CPU.
```
Describes the allocation and distribution of computing resources for the simulation. Note that `ntasks` can be automatically calculated when set to `-1`.

## [parallelization_params_websky]
```markdown
tlimit_map         = '12:00:00'        # Time limit for Websky runs.
nnodes_map         = 1                 # Number of nodes for single Websky runs.
ppn_map            = 1                 # Tasks per node in map making.
ntasks_map         = -1                # Number of parallel tasks for map making, automatically calculated when set to -1.
np_map             = 40                # CPUs per task, specifically configured for Niagara's architecture.
nompth_map         = 1                 # Threads per CPU, usually 1.
```
This section configures parallelization parameters for Websky map-making processes, optimizing resource allocation for efficient computation.

## [redshifts]
```markdown
ievol              = 1    # Evolution along line of sight for light-cone runs, enabling dynamic redshift calculation.
num_redshifts      = 1    # Number of redshifts; more than 1 disables `ievol`.
maximum_redshift   = 3.0  # Upper limit of redshift range if multiple redshifts are simulated.
global_redshift    = 0.0  # Single or minimum redshift for simulations.
```
Details the configuration for simulating at single or multiple redshifts, crucial for defining the cosmological depth of the simulation.

## [peak_displacement]
```markdown
ilpt               = 2 # Peak displacement method: 1 for 1LPT, 2 for 2LPT (second-order Lagrangian perturbation theory).
ioutfield          = 1 # Output field type: 1 for density, 2 for both density and displacements.
ireadfield         = 0 # Read external field if 1, otherwise generate from seed and power spectrum.
iwant_field_part   = 0 # Determines if masked and unmasked peaks are included in the output.
fielddir           = 'fields/' # Directory for storing field data.
densfilein         = -1 # Input density file, automatically set based on run_name if -1.
densfileout        = -1 # Output density file, automatically set based on run_name if -1.
```
Configures how density peaks are displaced in the simulation grid, impacting the initial conditions and structure formation.

## [nongaussianities]
```markdown
NonGauss           = 0    # Type of non-Gaussianity: 0 for Gaussian, others for various non-Gaussian models.
fNL                = 10000. # Strength of non-Gaussianity, relevant if NonGauss is not 0.
A_nG = 1.0e-23 # Amplitude of chi power spectrum for specific non-Gaussian models.
B_nG = 1.0e-10 # High-k amplitude, mitigating hard cutoff.
R_nG = 64.0    # Characteristic scale for non-Gaussian peaks.
m_phi    = 1.0 # Mass of inflaton for dynamic non-Gaussian models.
m_chi    = 1.0 # Mass of additional inflationary field.
phi_w    = 0.12547 # Range low of inflaton during instability.
phi_p    = 8.49953 # Range high of inflaton during instability.
vev      = 0.1 # Vacuum expectation value in specific non-Gaussian models.
m_tach   = 1.25e3 # Tachyonic mass in specific models.
a_e      = 4.9e-55 # Scale factor at end of instability.
```
Defines the parameters for simulating non-Gaussian initial conditions, crucial for studies on early universe physics and inflation.

## [merging_algorithm]
```markdown
iZeld        = -1 # Lagrangian merging strategy, automatically calculated if -1.
ntilemerge   = -1 # Number of tiles for merging, automatically calculated if -1.
ntasksmerge  = -1 # Number of tasks for merging, automatically calculated if -1.
iwrap        = 0  # Controls boundary wrapping in merging.
```
Configures how halos are merged post-simulation, impacting the halo catalogue's accuracy and completeness.

## [websky_parameters]
```markdown
maps         = 'tsz ksz tau kap' # Types of sky maps to produce: tSZ, kSZ, optical depth, and lensing convergence.
nside_map    = 512 # HEALPix resolution parameter for spherical tessellation.
npix_map     = 512 # Resolution for square field-of-view tessellation.
fov_map      = 10. # Field of view in degrees.
zmin_map     = 0.0 # Minimum redshift for secondary anisotropies.
zmax_map     = 1.245 # Maximum redshift for secondary anisotropies.
tabfile_map  = 'bbps_1.tab' # Halo pressure profile table for map-making.
tabfile_sfr  = 'sfr_behroozi.dat' # Star formation rate data file.
model_map    = 1 # Model identifier for map generation.
scramble_map = 0 # Option to scramble halo positions.
center_map   = 0 # Option to recenter maps around the most massive halo.
chihview_map = 0 # Displaces map viewpoint, useful for specific observational perspectives.
PSZcut_map   = 0 # Applies a selection function to match Planck observations.
ellmax       = 512 # Maximum multipole for C_l calculations in HEALPix.
```
Details the parameters for generating sky maps based on the halo catalogue, crucial for studies on cosmic microwave background and large-scale structure.

## [cosmology]
```markdown
Omx          = 0.2645 # Omega_c, the density fraction of cold dark matter.
OmB          = 0.0493 # Omega_b, the density fraction of baryons.
Omvac        = -1.0   # Omega_Lambda, density fraction of dark energy, automatically calculated if -1.
h            = 0.6735 # Hubble parameter scaled by 100 km/s/Mpc.
ns           = 0.9649 # Spectral index of primordial power spectrum.
As           = 2.100e-9 # Amplitude of the primordial zeta power spectrum.
sigma8       = 0.8111 # Normalization of the matter power spectrum.
tau          = 0.0544 # Optical depth to reionization.
mnu          = 0.0    # Sum of neutrino masses.
pkfile       = 'planck18_intermittent.dat' # Power spectrum data file.
```
Defines the base cosmological parameters used in the simulation, directly affecting the theoretical background of the universe model.

## [ellipsoidal_collapse]
```markdown
ioutshear          = 0   # Determines whether the shear tensor is outputted.
rmax2rs            = 0.0 # Max ratio of peak search radius to smoothing filter scale. If not greater than 0.0, search all the way out to nbuff.
wsmooth            = 1   # Smoothing window function type: 0 for Gaussian, 1 for top-hat.
Rsmooth_max        = 34. # Maximum filter scale in Mpc.
TabInterpFile      = 'HomelTab.dat' # File for tabulated interpolation of collapse dynamics.
TabInterpNx        = 50  # Grid size in x-direction for table interpolation.
TabInterpNy        = 20  # Grid size in y-direction for table interpolation.
TabInterpNz        = 20  # Grid size in z-direction for table interpolation.
TabInterpX1        = 1.5 # Minimum x-value for log10 transformation in table interpolation.
TabInterpX2        = 8.0 # Maximum x-value for log10 transformation in table interpolation.
TabInterpY1        = 0.0 # Minimum y-value for table interpolation.
TabInterpY2        = 0.5 # Maximum y-value for table interpolation.
TabInterpZ1        = -0.99990 # Minimum z-value adjusted for numerical stability in table interpolation.
TabInterpZ2        =  0.99990 # Maximum z-value adjusted for numerical stability in table interpolation.
filterfile         = 'tables/filter.dat' # Specifies the file containing filter data for peak identification.
```
Ellipsoidal collapse models are used to predict the non-linear evolution of density peaks in the early universe. This section configures how these calculations are performed, including the specifics of the interpolation used for tabulating the dynamics of collapsing structures.
Keep in mind that `TabInterpZ1`, `TabInterpZ2` cannot be equal to +-1, otherwise the code will result in error.

## [lattice_parameters_hpkvd]
```markdown
nsub           = -1   # Subdivision of mesh, automatically calculated if -1.
next           = -1   # Extended mesh size, automatically calculated if -1.
dcore_box      = -1.0 # Core box dimension, automatically calculated if -1.0.
cellsize       = -1.0 # Cell size in the mesh, automatically calculated if -1.0.
buffersize     = -1.0 # Buffer size around tiles, automatically calculated if -1.0.
dL_box         = -1.0 # Dimension of the lattice box including buffers, automatically calculated if -1.0.
mlatt          = -1.0 # Mass per lattice point, automatically calculated if -1.0.
cenx           = 0.0  # X-coordinate of the observer in the lattice.
ceny           = 0.0  # Y-coordinate of the observer in the lattice.
cenz           = 0.0  # Z-coordinate of the observer in the lattice.
```
Configures the lattice parameters for the simulation grid, which define the resolution and granularity of the cosmological volume.

## [advanced_merge_pkvd]
```markdown
iLexc = 3  # Lagrangian exclusion criterion: 0=None, 1=(D=0), 2=(D<R1-R2), 3=(D<R1), 4=(D<R1+R2).
iLmrg = 0  # Lagrangian merge criterion: 0=None, 1=BinaryReduceMass.
iFexc = 0  # Final-state exclusion criterion: 0=None 1=(D<f*(R1+R2)).
iFmrg = 0  # Final-state merge criterion: 0=None 1=Link 2=AddMass+mrg.
```
These advanced merging parameters control the handling and processing of halo overlaps and mergers in the final simulation output, ensuring physically meaningful results based on specified geometric and dynamical criteria.

---

### Note on Automatic Calculations
Several parameters within this configuration file, notably those set to `-1` or `-1.0`, are designed for automatic calculation based on other provided values or defaults defined in the simulation code. This automation ensures that the simulation adapts dynamically to various settings without requiring manual input for these parameters.

Parameters that support automatic calculation (set to `-1`, `-1.0`, or similar):
- `ntasks` in [parallelization_params]
- `ntasks_map` in [parallelization_params_websky]
- `densfilein` and `densfileout` in [peak_displacement]
- Lattice and tiling dimensions in [lattice_parameters_hpkvd] and [merging_algorithm] sections such as `nsub`, `next`, `dcore_box`, `cellsize`, `buffersize`, `dL_box`, `mlatt`, `nlx`, `nly`, `nlz`, `n1`, `n2`, `n3`.

All these automatic calculations are performed in `modules/ini_reader/config_reader.f90`, `evaluate_parameters` subroutine.
